DECLARE
@DATAINI AS DATETIME
SET @DATAINI = '2025-02-01'  -- Data mínima considerada
SELECT DISTINCT
    D.CPF_DEV AS [CPF],
	F.COD_CLI AS [CODIGO CLIENTE],
	F.COD_CAR AS [CODIGO DA CARTEIRA],
	F.CONTRATO_FIN AS [CONTRATO],
	AX.ID_DIVIDA AS [ID DA DIVIDA],
	XF.CONTRATO_ORIGINAL AS [CONTRATO ORIGINAL],
	A.NUMACORDO_ACO AS [NUMERO DO ACORDO],
	R.PARCELA_PARC AS [PARCELA],
	A.PLANO_ACO AS [PLANO],
	F.ATRASO_FIN AS [DIAS EM ATRASO],
	CASE 
        WHEN F.ATRASO_FIN < 180 THEN '00. < 6 meses'
        WHEN F.ATRASO_FIN BETWEEN 180 AND 269 THEN '01. 6 a 9 meses'
        WHEN F.ATRASO_FIN BETWEEN 270 AND 364 THEN '02. 9 meses a 1 ano'
        WHEN F.ATRASO_FIN BETWEEN 365 AND 729 THEN '03. 1 a 2 anos'
        WHEN F.ATRASO_FIN BETWEEN 730 AND 1094 THEN '04. 2 a 3 anos'
        WHEN F.ATRASO_FIN BETWEEN 1095 AND 1459 THEN '05. 3 a 4 anos'
        WHEN F.ATRASO_FIN BETWEEN 1460 AND 1824 THEN '06. 4 a 5 anos'
        WHEN F.ATRASO_FIN BETWEEN 1825 AND 2189 THEN '07. 5 a 6 anos'
        WHEN F.ATRASO_FIN BETWEEN 2190 AND 2554 THEN '08. 6 a 7 anos'
        WHEN F.ATRASO_FIN BETWEEN 2555 AND 2919 THEN '09. 7 a 8 anos'
        WHEN F.ATRASO_FIN BETWEEN 2920 AND 4014 THEN '10. 8 a 11 anos'
        WHEN F.ATRASO_FIN BETWEEN 4015 AND 5109 THEN '11. 11 a 14 anos'
        WHEN F.ATRASO_FIN BETWEEN 5110 AND 6204 THEN '12. 14 a 17 anos'
        ELSE '13. > 17 anos'
    END AS 'FAIXA DE ATRASO',
    CASE
        WHEN R.PARCELA_PARC = 1 THEN 'NOVO'
        ELSE 'COLCHÃO'
    END AS [TIPO DE ACORDO],
    CONVERT(VARCHAR, R.DATA_PAGTO, 103) AS [DATA PAGAMENTO],
    A.VLRACORDO_ACO AS [VLR DO ACORDO],
    R.VALOR_PARC AS [VLR DO PAGAMENTO],
    A.VLRACORDO_ACO - R.VALOR_PARC AS [REFIN], -- Nova coluna
    R.VALOR_PARC * 0.30 AS [RECEITA], -- Correção do cálculo
    CASE 
        WHEN U.LOGIN_RECUP IS NOT NULL THEN 'DIRETO'
        ELSE 'INDIRETO'
    END AS 'TIPO RECUPERADOR',
    CAR.DESC_CAR AS [CARTEIRA],
    AX.NOME_PORTFOLIO AS [PRODUTO]
    
FROM RECIBOCREDOR (NOLOCK) AS R
INNER JOIN CAD_DEVF (NOLOCK)  AS F ON F.CONTRATO_FIN = R.CONTRATO_FIN
INNER JOIN AUX_DEVF (NOLOCK) AS XF ON F.CONTRATO_FIN = XF.CONTRATO_FIN
INNER JOIN CAD_DEV (NOLOCK)   AS D ON D.CPF_DEV = F.CPF_DEV
INNER JOIN CAD_ACO (NOLOCK)   AS A ON A.CONTRATO_FIN = R.CONTRATO_FIN
                                   AND A.NACORDO_ACO = R.NACORDO_ACO
INNER JOIN CAD_ACOP (NOLOCK)  AS AP ON AP.CONTRATO_FIN = R.CONTRATO_FIN
                                   AND AP.NACORDO_ACO = R.NACORDO_ACO
                                   AND AP.PARCELA_ACOP = R.PARCELA_PARC
LEFT JOIN CAD_RECUP (NOLOCK)  AS U ON U.COD_RECUP = A.RECUP_ACO
INNER JOIN CAD_CAR (NOLOCK)   AS CAR ON CAR.COD_CAR = F.COD_CAR AND CAR.COD_CLI = F.COD_CLI
INNER JOIN CAD_TIPESS (NOLOCK) AS TP ON TP.COD_TIPESS = D.COD_TIPESS
LEFT JOIN AUX_SANTANDERPIC_REMESSA AS AX ON AX.CONTRATO_FIN = F.CONTRATO_FIN
WHERE
    F.COD_CLI IN (182,232)  -- Filtra as carteiras específicas
    AND R.DATA_PAGTO >= @DATAINI
    AND A.VLRACORDO_ACO > 0
    --AND ISNULL(U.LOGIN_RECUP, 'INDIRETO') NOT IN ('SERASAPLM', 'ACORDOCERT') -- Remove recuperadores específicos
    AND (
        (F.COD_CLI = 182 AND F.COD_CAR IN (7, 8, 9, 10, 11, 12, 13, 14, 15)) -- Apenas 7 a 15 para COD_CLI 182
        OR (F.COD_CLI = 232 AND F.COD_CAR IN (1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12)) -- Mantém todos para 232
    )
